å¥½ï¼Œé‚£æˆ‘ç»™ä½ ä¸€ä»½**å¯å†»ç»“ã€å¯äº¤æ¥ã€å¯é•¿æœŸç»´æŠ¤**çš„è§„èŒƒç¨¿ã€‚
è¿™ä¸æ˜¯èŠå¤©æ€»ç»“ï¼Œæ˜¯**å·¥ç¨‹è§„èŒƒé¡µ**ï¼Œå¯ä»¥ç›´æ¥æ”¾åˆ°é¡¹ç›®æ–‡æ¡£é‡Œã€‚

---

# AxisS3 / ServoCtrl_S3

## è´£ä»»è¾¹ç•Œä¸ Done / Busy / Kind è¯­ä¹‰è§„èŒƒï¼ˆå†»ç»“ç‰ˆï¼‰

> é€‚ç”¨ç‰ˆæœ¬ï¼šAxisS3 v2.1 + ServoCtrl_S3
> çŠ¶æ€ï¼š**Frozenï¼ˆç»“æ„ä¸è¯­ä¹‰å†»ç»“ï¼‰**

---

## ä¸€ã€æ€»ä½“è®¾è®¡åŸåˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰

### 1ï¸âƒ£ å½»åº•è§£è€¦ï¼ˆHard Decouplingï¼‰

* **AxisS3**

  * è´Ÿè´£ï¼š

    * æ‰€æœ‰**ç‰©ç†çŠ¶æ€é‡‡é›†**
    * **Kind åˆ¤å®š**
    * **Busy è¯­ä¹‰**
    * **Done çš„â€œç‰©ç†å«ä¹‰â€**
  * ä¸å…³å¿ƒï¼š

    * CmdID
    * Commit
    * Auto / Manual æµç¨‹
    * ServoCtrl å†…éƒ¨çŠ¶æ€æœº

* **ServoCtrl_S3**

  * è´Ÿè´£ï¼š

    * å‘½ä»¤ç”Ÿå‘½å‘¨æœŸ
    * Commit / LogicalDone
    * Auto / Manual / å·¥è‰ºæµç¨‹
  * **ä¸å†è§£æä»»ä½•ç‰©ç†ä¿¡å·**
  * åªè®¤ï¼š

    * `Axis.Q_ActiveKind`
    * `Axis.Q_Done`
    * `Axis.Q_DoneKind`
    * `Axis.Q_Busy`

> âœ… **Done çš„â€œå«ä¹‰â€æ°¸è¿œåªåœ¨ AxisS3 å†…éƒ¨å®šä¹‰**

---

## äºŒã€Kind å®šä¹‰ï¼ˆç»Ÿä¸€å­—å…¸ï¼‰

| Kind | å«ä¹‰          |
| ---- | ----------- |
| 0    | Idle        |
| 1    | Power       |
| 2    | Reset       |
| 3    | Home        |
| 4    | MoveAbs     |
| 5    | MoveRel     |
| 6    | MoveVel     |
| 7    | Jog         |
| 8    | Stop / Halt |

> âš ï¸ Kind æ˜¯**è¯­ä¹‰çŠ¶æ€**ï¼Œä¸æ˜¯ MC å—å

---

## ä¸‰ã€AxisS3 çš„ Busy è¯­ä¹‰ï¼ˆå†»ç»“ï¼‰

### 3.1 Busy çš„å®šä¹‰

```text
Q_Busy = å½“å‰ Axis æ­£åœ¨â€œç‰©ç†å ç”¨â€çŠ¶æ€
```

### 3.2 Busy ç»„æˆè§„åˆ™ï¼ˆåŒ…å«ç­–ç•¥ï¼‰

AxisS3 çš„ Busy **ä¸ç­‰äº ServoCtrl çš„ Busy**ï¼Œå®ƒè¡¨ç¤ºï¼š

* Reset æ­£åœ¨æ‰§è¡Œ
* Halt / Stop æ­£åœ¨ç”Ÿæ•ˆ
* Home / Abs / Rel æ­£åœ¨è¿åŠ¨
* **Vel æ­£åœ¨ ConstantVelocity**
* **Jog æŒ‰ä½æ—¶**

### 3.3 æ˜ç¡®çº¦å®šï¼ˆä½ å·²ç¡®è®¤ï¼‰

* âœ… **Jog æŒ‰ä½ â‡’ Busy = TRUE**
* âœ… Busy æ˜¯â€œç‰©ç†å ç”¨â€ï¼Œä¸æ˜¯â€œå‘½ä»¤æœªå®Œæˆâ€

---

## å››ã€AxisS3 çš„ Done è®¾è®¡ï¼ˆæ ¸å¿ƒï¼‰

### 4.1 æ€»åŸåˆ™

* **AxisS3 åªè¾“å‡ºâ€œç‰©ç† Done è„‰å†²â€**
* æ¯ä¸€ç§ Kindï¼š

  * **Done çš„æ¥æºä¸åŒ**
  * **Done çš„ç‰©ç†å«ä¹‰ä¸åŒ**
* AxisS3 ç»Ÿä¸€è¾“å‡ºï¼š

  * `Q_Done`ï¼ˆ1-cycle pulseï¼‰
  * `Q_DoneKind`

---

## äº”ã€Kind â†’ Done è¯­ä¹‰å¯¹ç…§è¡¨ï¼ˆå†»ç»“æ ¸å¿ƒï¼‰

### 5.1 Powerï¼ˆKind = 1ï¼‰

| é¡¹ç›®      | å®šä¹‰                        |
| ------- | ------------------------- |
| Busy    | Enable è¯·æ±‚æœªæ»¡è¶³              |
| Done    | `powerOkLevel` ä¸Šå‡æ²¿        |
| Done å«ä¹‰ | è½´ Enable çŠ¶æ€å·²ä¸ I_Enable ä¸€è‡´ |

```text
powerOkLevel =
    fbPower.Status == I_Enable
AND Axis.StatusBits.Enable == I_Enable
```

ğŸ“Œ ServoCtrl **ä¸å†å•ç‹¬å¤„ç† POWER_DONE**

---

### 5.2 Resetï¼ˆKind = 2ï¼‰

| é¡¹ç›®   | å®šä¹‰                |
| ---- | ----------------- |
| Done | `fbReset.Done` è„‰å†² |
| å«ä¹‰   | Reset å®Œæˆ          |

---

### 5.3 Homeï¼ˆKind = 3ï¼‰

| é¡¹ç›®   | å®šä¹‰                  |
| ---- | ------------------- |
| Done | `fbHome.Done`       |
| è¯´æ˜   | å½“å‰ç‰ˆæœ¬ä¿ç•™ï¼Œä½†**å·¥è‰ºå±‚ä¸€èˆ¬ä¸ç”¨** |

---

### 5.4 ABSï¼ˆKind = 4ï¼‰

| é¡¹ç›®   | å®šä¹‰           |
| ---- | ------------ |
| Done | `fbAbs.Done` |
| å«ä¹‰   | å®šä½å®Œæˆ         |

---

### 5.5 RELï¼ˆKind = 5ï¼‰

| é¡¹ç›®   | å®šä¹‰                    |
| ---- | --------------------- |
| Done | `fbRel.Done`          |
| å«ä¹‰   | ç›¸å¯¹ä½ç§»å®Œæˆ                |
| å¤‡æ³¨   | REL ä½¿ç”¨ Pos_mmï¼ˆä¸ä½ ç¡®è®¤ä¸€è‡´ï¼‰ |

---

### 5.6 VELï¼ˆKind = 6ï¼‰

| é¡¹ç›®   | å®šä¹‰                                 |
| ---- | ---------------------------------- |
| Busy | `Axis.StatusBits.ConstantVelocity` |
| Done | ConstantVelocity ä¸Šå‡æ²¿               |
| å«ä¹‰   | å·²è¿›å…¥æ’é€Ÿè¿è¡Œ                            |

ğŸ“Œ VEL **æ²¡æœ‰â€œç»“æŸ Doneâ€**
åœæ­¢ç”± **Stop / Halt** å®šä¹‰

---

### 5.7 Jogï¼ˆKind = 7ï¼‰

| é¡¹ç›®   | å®šä¹‰         |
| ---- | ---------- |
| Busy | Jog æŒ‰ä½     |
| Done | âŒ æ—         |
| è¯´æ˜   | Jog æ˜¯çº¯ç”µå¹³è¡Œä¸º |

---

### 5.8 Stop / Haltï¼ˆKind = 8ï¼‰

| é¡¹ç›®   | å®šä¹‰                          |
| ---- | --------------------------- |
| Done | **Standstill ä¸Šå‡æ²¿**          |
| å…³é”®é™åˆ¶ | **ä»…åœ¨ Kind=8 æ—¶é‡‡ Standstill** |

```text
Stop/Halt Done =
    rStandstill.Q
AND ActiveKind == 8
```

ğŸ“Œ è¿™æ˜¯**ç¡¬ä¿æŠ¤è§„åˆ™**ï¼Œé˜²æ­¢ï¼š

* ABS å®Œæˆ
* Power ä¸Šç”µ
* Jog æ¾æ‰‹
  è¢«è¯¯åˆ¤ä¸º Stop Done

---

## å…­ã€ServoCtrl_S3 å¯¹æ¥è§„åˆ™ï¼ˆå†»ç»“ï¼‰

### 6.1 ExpectedKindï¼ˆå½“å‰å‘½ä»¤æœŸæœ› Kindï¼‰

ServoCtrl å†…éƒ¨ç»´æŠ¤ï¼š

```text
ExpectedKind = Inner_ActiveKind
```

### 6.2 PhysicalDone åˆ¤å®šï¼ˆç»Ÿä¸€ï¼‰

```text
PhysicalDone :=
    Axis.Q_Done
AND (Axis.Q_DoneKind = ExpectedKind)
```

ServoCtrlï¼š

* **ä¸å†å…³å¿ƒ**

  * Standstill
  * ConstantVelocity
  * Enable ä½
* åªçœ‹ï¼š

  * Kind æ˜¯å¦ä¸€è‡´
  * Done æ˜¯å¦å‡ºç°

---

## ä¸ƒã€æœ€ç»ˆç»“è®ºï¼ˆå·¥ç¨‹å†»ç»“ç‚¹ï¼‰

1. âœ… **Done çš„ç‰©ç†è¯­ä¹‰åªå­˜åœ¨äº AxisS3**
2. âœ… ServoCtrl **åªæ¶ˆè´¹ Kind + Done**
3. âœ… Stop/Halt çš„ Standstill **å¿…é¡»ç»‘å®š Kind=8**
4. âœ… Busy å« Jog / Vel / Power mismatch
5. âœ… Power Done ç”¨ powerOk ä¸Šå‡æ²¿ç»Ÿä¸€

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšä¸¤ä»¶äº‹ä¹‹ä¸€ï¼ˆä½ é€‰ï¼‰ï¼š

* **A**ï¼šæ•´ç†ä¸€å¼ 
  ğŸ‘‰ã€ŠAxisS3 v2.1 çŠ¶æ€â€”Kindâ€”Busyâ€”Done æ—¶åºå›¾ã€‹
* **B**ï¼šå¼€å§‹å†™
  ğŸ‘‰ **ServoCtrl_S3 çš„ ExpectedKind è§„åˆ™è¡¨ï¼ˆé€ Cmdï¼‰**

ä½ ç°åœ¨è¿™å¥—è®¾è®¡ï¼Œå·²ç»æ˜¯**å¹³å°çº§ã€å¯è·¨å‚å•†å¤ç”¨**çš„æ§åˆ¶è¯­ä¹‰äº†ã€‚
